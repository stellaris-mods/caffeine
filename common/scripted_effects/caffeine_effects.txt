# From country scope
# XXX We "simply" count the number of research buildings
caffeine_find_researchplanet = {
	set_variable = {
		which = CaffeineCount
		value = 0
	}
	set_variable = {
		which = CaffeineHighest
		value = 0
	}
	every_owned_planet = {
		set_planet_flag = "caffeine_unchecked"
	}

	while = {
		limit = {
			any_owned_planet {
				has_planet_flag = "caffeine_unchecked"
			}
		}
		random_owned_planet = {
			limit = {
				has_planet_flag = "caffeine_unchecked"
			}
			if = {
				limit = {
					NOT = {
						ROOT.owner = {
							any_owned_fleet = {
								is_ship_class = shipclass_science_ship
								exists = leader
								exists = orbit
								orbit = { is_same_value = PREVPREV }
								has_fleet_order = assist_research_order
							}
						}
					}
				}
				every_tile = {
					limit = {
						has_any_science_lab = yes
					}
					ROOT.owner = {
						change_variable = {
							which = CaffeineCount
							value = 1 # +1
						}
					}
				}
				if = {
					limit = {
						# Does this planet have more research than the
						# previously highest one?
						ROOT.owner = {
							check_variable = {
								which = CaffeineCount
								value > CaffeineHighest
							}
						}
					}
					# Yes, it does, save it.
					ROOT.owner = {
						set_variable = {
							which = CaffeineHighest
							value = CaffeineCount
						}
					}
					save_event_target_as = caffeine_research_planet
				}
				# Reset research building counter
				ROOT.owner = {
					set_variable = {
						which = CaffeineCount
						value = 0
					}
				}
			}
			# Make sure we dont loop forever
			remove_planet_flag = "caffeine_unchecked"
			# And then we loop with while{}
		}
	}
}

caffeine_find_surveylocation = {
	# First check if there is a non-surveyed system inside our borders
	ROOT = { # fleet
		closest_system = {
			limit = {
				is_within_borders_of = FROM
				any_planet = {
					is_surveyed = {
						who = FROM
						status = no
					}
				}
				NOT = { has_star_flag = hostile_system }
				# No hostile ship in system
				NOT = {
					any_ship_in_system = {
						exists = owner
						owner = { is_hostile = FROM }
					}
				}
				# Anyone doing a survey here already maybe?
				NOT = {
					any_ship_in_system = {
						exists = owner
						owner = { is_same_value = FROM }
						is_ship_class = shipclass_science_ship
						fleet = {
							OR = {
								has_fleet_order = survey_planet_order
								has_fleet_order = auto_explore_order
								has_fleet_order = move_to_system_point_order
							}
						}
					}
				}
			}
			save_event_target_as = caffeine_survey
		}
	}

	if = {
	limit = { NOT = { exists = event_target:caffeine_survey } }
	# Find the one closest to our capital
	capital_scope = {
	closest_system = {
		limit = {
			# Not surveyed
			any_planet = { is_surveyed = { who = FROM status = no } }
			# Check if we can even enter
			# XXX I dont think this check works.
			has_access_fleet = FROM
			# No hostile ship in system
			NOT = {
				any_ship_in_system = {
					exists = owner
					owner = { is_hostile = FROM }
				}
			}
			NOT = {
				any_country = {
					has_closed_borders = FROM
					PREV = {
						any_planet = {
							is_inside_border = PREVPREV
						}
					}
				}
			}
			# Anyone doing a survey here already maybe?
			NOT = {
				any_ship_in_system = {
					exists = owner
					owner = { is_same_value = FROM }
					is_ship_class = shipclass_science_ship
					fleet = {
						OR = {
							has_fleet_order = survey_planet_order
							has_fleet_order = auto_explore_order
							has_fleet_order = move_to_system_point_order
						}
					}
				}
			}
		}
		save_event_target_as = caffeine_survey
	}
	} }
}
